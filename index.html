<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CAI 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .last-update {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: white;
        }

        .desa-utara-1 { background: #dc3545; }
        .desa-utara-2 { background: #fd7e14; }
        .desa-selatan { background: #28a745; }
        .desa-baki-1 { background: #ffc107; color: #333; }
        .desa-baki-2 { background: #17a2b8; }

        .card-content {
            padding: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .kelompok {
            color: #555;
        }

        .kiriman {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .refresh-btn:active {
            transform: rotate(360deg);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 50px;
        }

        .error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Dashboard CAI 2025</h1>
            <div class="last-update">
                <span id="lastUpdate">Memuat data...</span><br>
                <small id="connectionStatus">🔗 Menghubungkan ke Google Sheets...</small>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="totalPeserta">-</div>
                <div class="stat-label">Total Peserta</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDesa">-</div>
                <div class="stat-label">Total Desa</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalKelompok">-</div>
                <div class="stat-label">Total Kelompok</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalKiriman">-</div>
                <div class="stat-label">Total Kiriman</div>
            </div>
        </div>

        <div id="dashboardContent" class="dashboard-grid">
            <div class="loading">Memuat data dari spreadsheet...</div>
        </div>

        <button class="refresh-btn" onclick="loadData()" title="Refresh Data">
            🔄
        </button>
    </div>

    <script>
        // Sample data - replace with actual Google Sheets API call
        const sampleData = {
            "DESA UTARA 1": {
                "Prenggon Timur": 0,
                "Sanggrahan": 0,
                "Karang": 0,
                "Mantung": 0,
                "Candi Selatan": 0,
                "Candi Utara": 0,
                "Cemani": 0
            },
            "DESA UTARA 2": {
                "Gondang": 0,
                "Plumbon": 0,
                "Ngenden": 0,
                "Badongan": 0,
                "Prenggon Barat": 0,
                "Prenggon Selatan": 0,
                "Dukuh": 0
            },
            "DESA SELATAN": {
                "Nampan": 0,
                "Beran": 0,
                "Gedangan": 0,
                "Soka": 0,
                "Pasekan": 0,
                "Temusu Timur": 0,
                "Temusu Utara": 0,
                "Temusu Barat": 0,
                "Tegol Baru": 0,
                "Kadokan": 0
            },
            "DESA BAKI 1": {
                "Dukuh Mancasan": 0,
                "Mancasan": 0,
                "Branglor Utara": 0,
                "Branglor Selatan": 0,
                "Jotangan": 0,
                "Teplok": 0,
                "Kauman": 0,
                "Tapusun": 0
            },
            "DESA BAKI 2": {
                "Kragilan": 0,
                "Kemasan": 0,
                "Jetis": 3,
                "Bakalan": 0,
                "Junglang": 0,
                "Karang Beton": 0,
                "Sayangan": 0
            }
        };

        function loadData() {
            // Show loading
            document.getElementById('dashboardContent').innerHTML = '<div class="loading">🔄 Memuat data real-time dari Google Sheets...</div>';
            updateLastUpdate('loading');
            
            // Load real data from Google Sheets
            loadDataFromSheets().then(() => {
                updateLastUpdate('success');
            }).catch(() => {
                // Fallback to sample data if Sheets fails
                console.log('Falling back to sample data');
                renderDashboard();
                updateLastUpdate('error');
            });
        }

        function renderDashboard() {
            const container = document.getElementById('dashboardContent');
            let html = '';
            let totalPeserta = 0;
            let totalKelompok = 0;
            let totalKiriman = 0;

            for (const [desa, kelompokData] of Object.entries(sampleData)) {
                const desaClass = desa.toLowerCase().replace(/\s+/g, '-');
                let desaKiriman = 0;
                
                html += `
                    <div class="card">
                        <div class="card-header ${desaClass}">
                            ${desa}
                        </div>
                        <div class="card-content">
                `;

                for (const [kelompok, kiriman] of Object.entries(kelompokData)) {
                    html += `
                        <div class="data-row">
                            <span class="kelompok">${kelompok}</span>
                            <span class="kiriman">${kiriman}</span>
                        </div>
                    `;
                    desaKiriman += kiriman;
                    totalKelompok++;
                }

                html += `
                        </div>
                    </div>
                `;
                
                totalKiriman += desaKiriman;
                if (desaKiriman > 0) totalPeserta++;
            }

            container.innerHTML = html;
            
            // Update statistics
            document.getElementById('totalPeserta').textContent = totalPeserta;
            document.getElementById('totalDesa').textContent = Object.keys(sampleData).length;
            document.getElementById('totalKelompok').textContent = totalKelompok;
            document.getElementById('totalKiriman').textContent = totalKiriman;
        }

        function updateLastUpdate(status = 'success') {
            const now = new Date();
            const timestamp = now.toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('lastUpdate').textContent = `Terakhir diperbarui: ${timestamp}`;
            
            const statusElement = document.getElementById('connectionStatus');
            if (status === 'success') {
                statusElement.textContent = '✅ Terhubung ke Google Sheets';
                statusElement.style.color = '#28a745';
            } else if (status === 'error') {
                statusElement.textContent = '❌ Gagal terhubung - menggunakan data fallback';
                statusElement.style.color = '#dc3545';
            } else {
                statusElement.textContent = '🔄 Menghubungkan ke Google Sheets...';
                statusElement.style.color = '#ffc107';
            }
        }

        // REAL-TIME Auto refresh every 30 seconds (not 5 minutes)
        setInterval(loadData, 30 * 1000); // 30 seconds for real-time feel

        // Page visibility API - refresh when user comes back to tab
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadData();
            }
        });

        // Initial load
        loadData();

        // REAL-TIME Google Sheets Integration
        const SHEET_CONFIG = {
            // Sheet ID dari URL Anda
            SHEET_ID: '1bnSr5SGPSVsY6UXurPwsuTQzg8r7ZYh1zisgFohc_bw',
            // GID untuk sheet "PESERTA CAI 2025" 
            GID: '529062017',
            // Gunakan metode JSONP untuk avoid CORS
            USE_JSONP: true
        };

        async function loadDataFromSheets() {
            try {
                // Metode 1: CSV Export (paling reliable untuk avoid CORS)
                const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/export?format=csv&gid=${SHEET_CONFIG.GID}`;
                
                // Gunakan proxy untuk avoid CORS jika perlu
                const PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(CSV_URL)}`;
                
                console.log('Attempting to fetch from:', CSV_URL);
                
                let response;
                try {
                    // Coba direct access dulu
                    response = await fetch(CSV_URL, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    console.log('Direct access successful');
                } catch (directError) {
                    // Jika gagal, gunakan proxy
                    console.log('Direct access failed, using proxy...', directError.message);
                    response = await fetch(PROXY_URL);
                    if (!response.ok) throw new Error(`Proxy failed: HTTP ${response.status}`);
                    console.log('Proxy access successful');
                }
                
                const csvText = await response.text();
                console.log('CSV data loaded, length:', csvText.length);
                console.log('First 300 chars:', csvText.substring(0, 300));
                
                if (csvText.length < 10) {
                    throw new Error('CSV data too short, possibly empty sheet');
                }
                
                const csvData = parseCSV(csvText);
                console.log('CSV parsed, rows:', csvData.length);
                
                if (csvData.length < 2) {
                    throw new Error('No data rows found in CSV');
                }
                
                processCAISheetData(csvData);
                return Promise.resolve();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="error">
                        ❌ Gagal memuat data dari Google Sheets<br>
                        <small><strong>Error:</strong> ${error.message}</small><br>
                        <small><strong>Sheet ID:</strong> ${SHEET_CONFIG.SHEET_ID}</small><br>
                        <small><strong>GID:</strong> ${SHEET_CONFIG.GID}</small><br>
                        <br>
                        <strong>Troubleshooting:</strong><br>
                        1. Pastikan sheet sudah di-share publicly<br>
                        2. Cek Sheet ID dan GID sudah benar<br>
                        3. Tunggu 10 detik, akan fallback ke data demo
                    </div>`;
                
                // Fallback to sample data after delay
                setTimeout(() => {
                    console.log('Using fallback sample data');
                    renderDashboard();
                }, 5000);
                
                return Promise.reject(error);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            return lines.map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            });
        }

        function processCAISheetData(rawData) {
            console.log('Processing CAI Sheet Data...', rawData.length, 'rows');
            
            // Initialize structure based on your sheet
            const caiData = {
                "DESA UTARA 1": {
                    "Prenggon Timur": 0,
                    "Sanggrahan": 0,
                    "Karang": 0,
                    "Mantung": 0,
                    "Candi Selatan": 0,
                    "Candi Utara": 0,
                    "Cemani": 0
                },
                "DESA UTARA 2": {
                    "Gondang": 0,
                    "Plumbon": 0,
                    "Ngenden": 0,
                    "Badongan": 0,
                    "Prenggon Barat": 0,
                    "Prenggon Selatan": 0,
                    "Dukuh": 0
                },
                "DESA SELATAN": {
                    "Nampan": 0,
                    "Beran": 0,
                    "Gedangan": 0,
                    "Soka": 0,
                    "Pasekan": 0,
                    "Temusu Timur": 0,
                    "Temusu Utara": 0,
                    "Temusu Barat": 0,
                    "Tegol Baru": 0,
                    "Kadokan": 0
                },
                "DESA BAKI 1": {
                    "Dukuh Mancasan": 0,
                    "Mancasan": 0,
                    "Branglor Utara": 0,
                    "Branglor Selatan": 0,
                    "Jotangan": 0,
                    "Teplok": 0,
                    "Kauman": 0,
                    "Tepusun": 0
                },
                "DESA BAKI 2": {
                    "Kragilan": 0,
                    "Kemasan": 0,
                    "Jetis": 0,
                    "Bakalan": 0,
                    "Junglang": 0,
                    "Karang Beton": 0,
                    "Sayangan": 0
                }
            };
            
            // Process data dari kolom A-E (peserta)
            let totalPesertaFromData = 0;
            
            for (let i = 1; i < rawData.length; i++) { // Skip header
                const row = rawData[i];
                if (row.length >= 3 && row[1] && row[2]) { // Ada desa dan kelompok
                    const desa = row[1].trim();
                    const kelompok = row[2].trim();
                    
                    // Normalisasi nama desa
                    let normalizedDesa = desa;
                    if (desa.includes('UTARA') && desa.includes('1')) normalizedDesa = 'DESA UTARA 1';
                    else if (desa.includes('UTARA') && desa.includes('2')) normalizedDesa = 'DESA UTARA 2';
                    else if (desa.includes('SELATAN')) normalizedDesa = 'DESA SELATAN';
                    else if (desa.includes('BAKI') && desa.includes('1')) normalizedDesa = 'DESA BAKI 1';
                    else if (desa.includes('BAKI') && desa.includes('2')) normalizedDesa = 'DESA BAKI 2';
                    
                    // Count peserta per kelompok
                    if (caiData[normalizedDesa] && caiData[normalizedDesa].hasOwnProperty(kelompok)) {
                        caiData[normalizedDesa][kelompok]++;
                        totalPesertaFromData++;
                    } else if (caiData[normalizedDesa]) {
                        // Jika kelompok baru, tambahkan
                        if (!caiData[normalizedDesa][kelompok]) {
                            caiData[normalizedDesa][kelompok] = 0;
                        }
                        caiData[normalizedDesa][kelompok]++;
                        totalPesertaFromData++;
                    }
                }
            }
            
            console.log('Processed CAI Data:', caiData);
            console.log('Total Peserta Found:', totalPesertaFromData);
            
            // Update the display
            renderDashboardFromData(caiData);
        }

        function renderDashboardFromData(data) {
            const container = document.getElementById('dashboardContent');
            let html = '';
            let totalPeserta = 0;
            let totalKelompok = 0;
            let totalKiriman = 0;

            for (const [desa, kelompokData] of Object.entries(data)) {
                const desaClass = desa.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                let desaKiriman = 0;
                
                html += `
                    <div class="card">
                        <div class="card-header ${desaClass}">
                            ${desa}
                        </div>
                        <div class="card-content">
                `;

                for (const [kelompok, kiriman] of Object.entries(kelompokData)) {
                    html += `
                        <div class="data-row">
                            <span class="kelompok">${kelompok}</span>
                            <span class="kiriman">${kiriman}</span>
                        </div>
                    `;
                    desaKiriman += kiriman;
                    totalKelompok++;
                }

                html += `
                        </div>
                    </div>
                `;
                
                totalKiriman += desaKiriman;
                if (desaKiriman > 0) totalPeserta++;
            }

            container.innerHTML = html;
            
            // Update statistics
            document.getElementById('totalPeserta').textContent = totalPeserta;
            document.getElementById('totalDesa').textContent = Object.keys(data).length;
            document.getElementById('totalKelompok').textContent = totalKelompok;
            document.getElementById('totalKiriman').textContent = totalKiriman;
        }
    </script>
</body>
</html>